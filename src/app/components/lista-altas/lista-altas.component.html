<div class="card">
    <div class="card-body">
        <h4 class="card-title">Lista de Altas de Existencias</h4>
        <p class="text-muted">Visualice y gestione las altas de existencias registradas</p>

        <!-- Filtros -->
        <div class="row mb-3">
            <div class="col-md-4">
                <label for="filtro-sucursal" class="form-label"><strong>Filtrar por Sucursal:</strong></label>
                <select
                    id="filtro-sucursal"
                    class="form-control"
                    [(ngModel)]="sucursalFiltro"
                    (change)="onFiltroChange()"
                    [disabled]="cargando">
                    <option [value]="sucursal.id" *ngFor="let sucursal of sucursales">
                        {{ sucursal.nombre }}
                    </option>
                </select>
            </div>

            <div class="col-md-4">
                <label for="filtro-estado" class="form-label"><strong>Filtrar por Estado:</strong></label>
                <select
                    id="filtro-estado"
                    class="form-control"
                    [(ngModel)]="estadoFiltro"
                    (change)="onEstadoChange()"
                    [disabled]="cargando">
                    <option [value]="estado" *ngFor="let estado of estados">
                        {{ estado }}
                    </option>
                </select>
            </div>

            <div class="col-md-4 d-flex align-items-end">
                <button
                    type="button"
                    class="btn btn-success me-2"
                    (click)="exportarExcel()"
                    [disabled]="cargando || altasFiltradas.length === 0">
                    <i class="fa fa-file-excel mr-1"></i>
                    Exportar Excel
                </button>
                <button
                    type="button"
                    class="btn btn-primary"
                    (click)="cargarAltas()"
                    [disabled]="cargando">
                    <i class="fa fa-refresh mr-1"></i>
                    {{ cargando ? 'Cargando...' : 'Actualizar' }}
                </button>
            </div>
        </div>

        <!-- Botón de cancelación múltiple -->
        <div class="row mb-3" *ngIf="!cargando && altasFiltradas.length > 0">
            <div class="col-md-12">
                <button
                    type="button"
                    class="btn btn-danger"
                    (click)="confirmarCancelacionMultiple()"
                    [disabled]="altasSeleccionadas.length === 0 || cancelando">
                    <i class="fa fa-times-circle mr-1"></i>
                    Cancelar Seleccionadas ({{ altasSeleccionadas.length }})
                </button>
                <small class="text-muted ms-3" *ngIf="altasSeleccionadas.length > 0">
                    Has seleccionado {{ altasSeleccionadas.length }} alta(s) para cancelar
                </small>
            </div>
        </div>

        <!-- Loading indicator -->
        <div class="alert alert-warning mb-3" *ngIf="cargando">
            <i class="fa fa-spinner fa-spin mr-2"></i>
            Cargando datos, por favor espere...
        </div>

        <!-- Mensaje sin datos -->
        <div class="alert alert-info mb-3" *ngIf="!cargando && altasFiltradas.length === 0">
            <i class="fa fa-info-circle mr-2"></i>
            No se encontraron altas de existencias con los filtros seleccionados
        </div>

        <!-- Tabla de altas -->
        <div class="table-responsive" *ngIf="!cargando && altasFiltradas.length > 0">
            <table class="table table-striped table-hover">
                <thead class="table-dark">
                    <tr>
                        <th class="checkbox-column">
                            <input
                                type="checkbox"
                                class="form-check-input"
                                (change)="toggleSeleccionarTodas($event)"
                                [disabled]="cancelando"
                                title="Seleccionar todas las altas activas">
                        </th>
                        <th>ID</th>
                        <th>Estado</th>
                        <th>Fecha</th>
                        <th>Producto</th>
                        <th>Cantidad</th>
                        <th>Costo Total 1</th>
                        <th>Costo Total 2</th>
                        <th>V. Cambio</th>
                        <th>Tipo Cálculo</th>
                        <th>Sucursal</th>
                        <th>Usuario</th>
                        <th>Observación</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    <tr *ngFor="let alta of altasFiltradas"
                        [class.table-success]="alta.estado?.trim() === 'ALTA'"
                        [class.table-danger]="alta.estado?.trim() === 'Cancel-Alta'"
                        [class.row-selected]="alta.seleccionado">
                        <td class="checkbox-column">
                            <input
                                type="checkbox"
                                class="form-check-input"
                                [(ngModel)]="alta.seleccionado"
                                (change)="toggleSeleccion(alta)"
                                [disabled]="cancelando || alta.estado?.trim() !== 'ALTA'"
                                *ngIf="alta.estado?.trim() === 'ALTA'">
                        </td>
                        <td>{{ alta.id_num }}</td>
                        <td>
                            <span class="badge"
                                [class.badge-success]="alta.estado?.trim() === 'ALTA'"
                                [class.badge-danger]="alta.estado?.trim() === 'Cancel-Alta'">
                                {{ alta.estado }}
                            </span>
                        </td>
                        <td>{{ alta.fecha_resuelto || alta.fecha || 'N/A' }}</td>
                        <td>
                            <div class="text-truncate" style="max-width: 250px;" [title]="alta.descripcion">
                                {{ alta.descripcion }}
                            </div>
                            <small class="text-muted">ID: {{ alta.id_art }}</small>
                        </td>
                        <td>
                            <strong>{{ alta.cantidad }}</strong>
                        </td>
                        <td class="text-end">
                            <span *ngIf="alta.costo_total_1 !== null && alta.costo_total_1 !== undefined">
                                {{ alta.costo_total_1 | currency:'ARS':'symbol-narrow':'1.2-2' }}
                            </span>
                            <span *ngIf="alta.costo_total_1 === null || alta.costo_total_1 === undefined" class="text-muted">
                                N/A
                            </span>
                        </td>
                        <td class="text-end">
                            <span *ngIf="alta.costo_total_2 !== null && alta.costo_total_2 !== undefined">
                                {{ alta.costo_total_2 | currency:'ARS':'symbol-narrow':'1.2-2' }}
                            </span>
                            <span *ngIf="alta.costo_total_2 === null || alta.costo_total_2 === undefined" class="text-muted">
                                N/A
                            </span>
                        </td>
                        <td class="text-end">
                            <span *ngIf="alta.vcambio !== null && alta.vcambio !== undefined">
                                {{ alta.vcambio | number:'1.2-4' }}
                            </span>
                            <span *ngIf="alta.vcambio === null || alta.vcambio === undefined" class="text-muted">
                                N/A
                            </span>
                        </td>
                        <td>
                            <span class="badge badge-calculo"
                                [class.badge-dinamico]="alta.tipo_calculo === 'dinamico'"
                                [class.badge-fijo]="alta.tipo_calculo === 'fijo'"
                                *ngIf="alta.tipo_calculo">
                                <i class="fa"
                                    [class.fa-refresh]="alta.tipo_calculo === 'dinamico'"
                                    [class.fa-lock]="alta.tipo_calculo === 'fijo'"></i>
                                {{ alta.tipo_calculo === 'dinamico' ? 'Dinámico' : 'Fijo' }}
                            </span>
                            <span *ngIf="!alta.tipo_calculo" class="text-muted">N/A</span>
                        </td>
                        <td>{{ getNombreSucursal(alta.sucursald) }}</td>
                        <td>
                            <small>{{ alta.usuario_res || alta.usuario }}</small>
                        </td>
                        <td>
                            <div class="text-truncate" style="max-width: 200px;" [title]="alta.observacion">
                                {{ alta.observacion }}
                            </div>
                        </td>
                        <td>
                            <div class="btn-group btn-group-sm" role="group">
                                <button
                                    type="button"
                                    class="btn btn-info"
                                    (click)="verDetalles(alta)"
                                    [disabled]="cancelando"
                                    title="Ver detalles">
                                    <i class="fa fa-eye"></i>
                                </button>
                                <button
                                    type="button"
                                    class="btn btn-danger"
                                    (click)="confirmarCancelacion(alta)"
                                    [disabled]="cancelando || alta.estado?.trim() !== 'ALTA'"
                                    title="Cancelar alta"
                                    *ngIf="alta.estado?.trim() === 'ALTA'">
                                    <i class="fa fa-times"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- Resumen -->
        <div class="row mt-3" *ngIf="!cargando && altasFiltradas.length > 0">
            <div class="col-md-12">
                <div class="alert alert-secondary">
                    <strong>Total de registros:</strong> {{ altasFiltradas.length }}
                    <span class="ms-3">
                        <strong>Activas:</strong> {{ cantidadActivas }}
                    </span>
                    <span class="ms-3">
                        <strong>Canceladas:</strong> {{ cantidadCanceladas }}
                    </span>
                </div>
            </div>
        </div>
    </div>
</div>
