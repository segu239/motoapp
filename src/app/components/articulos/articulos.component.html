<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                <h4 class="card-title">Artículos</h4>
                
                <!-- Loading indicator -->
                <div class="alert alert-warning mb-3" *ngIf="loading">
                    <i class="fa fa-spinner fa-spin mr-2"></i> 
                    Cargando datos, por favor espere...
                </div>
                
                <!-- Cache info message -->
                <div class="alert alert-success mb-3" *ngIf="!loading && fromCache">
                    <small>
                        <i class="fa fa-check-circle mr-1"></i> Datos cargados desde caché local para acceso rápido.
                        <button class="btn btn-sm btn-outline-primary ml-2" (click)="forceRefresh()">
                            <i class="fa fa-refresh mr-1"></i> Actualizar datos
                        </button>
                    </small>
                </div>
                
                <!-- Foreign currency info -->
                <div class="alert alert-info mb-3" *ngIf="valoresCambio && valoresCambio.length > 0">
                    <small>
                        <i class="fa fa-info-circle"></i> Los precios de los artículos con moneda extranjera han sido convertidos automáticamente según el valor de cambio actual.
                    </small>
                </div>
                
                <!-- Price error warning -->
                <div class="alert alert-warning mb-3" *ngIf="tienePreciosConError">
                    <small>
                        <i class="fa fa-exclamation-triangle"></i> <strong>Advertencia:</strong> 
                        Algunos artículos con moneda extranjera podrían mostrar precios incorrectos debido a un error en el procesamiento.
                        Las filas marcadas con <i class="fa fa-exclamation-triangle text-danger"></i> requieren atención.
                        <button class="btn btn-sm btn-outline-primary ml-2" (click)="forceRefresh()">
                            <i class="fa fa-refresh mr-1"></i> Intentar solucionar
                        </button>
                    </small>
                </div>
                
                <!-- Table with data - NUEVO: Lazy Loading -->
                <p-table #dtable [value]="articulos" [tableStyle]="{ 'min-width': '50rem' }" 
                    [paginator]="true" 
                    [rows]="rows"
                    [first]="first"
                    [rowsPerPageOptions]="[25,50,100]"
                    [totalRecords]="totalRegistros"
                    [showCurrentPageReport]="true"
                    [loading]="loading"
                    [lazy]="true"
                    (onLazyLoad)="loadDataLazy($event)"
                    [lazyLoadOnInit]="true"
                    [filterDelay]="300">
                    <ng-template pTemplate="caption">
                        <div class="d-flex flex-row align-items-center">
                            <!-- Columnas selector -->
                            <div class="ml-2 columnas-container">
                                <p-multiSelect [options]="cols" [(ngModel)]="selectedColumns" optionLabel="header"
                                    selectedItemsLabel="{0} Columnas Seleccionadas" 
                                    placeholder="Elija Columnas"
                                    (onChange)="onColumnSelectionChange()">
                                </p-multiSelect>
                            </div>
                            
                            <!-- Botón actualizar -->
                            <div class="ml-2">
                                <button class="btn btn-primary btn-actualizar" (click)="forceRefresh()" [disabled]="loading">
                                    <i class="fa fa-refresh mr-1" [class.fa-spin]="loading"></i> Actualizar
                                </button>
                            </div>
                            
                            <!-- Botón exportar Excel -->
                            <div class="ml-2">
                                <p-button icon="pi pi-file-excel" (click)="exportExcel()"
                                    styleClass="p-button-success"></p-button>
                            </div>
                            
                            <!-- Botón agregar artículo -->
                            <div class="ml-2">
                                <p-button icon="pi pi-plus-circle" [routerLink]="['../newarticulo']"
                                    styleClass="p-button-info"></p-button>
                            </div>
                        </div>
                    </ng-template>
                    <ng-template pTemplate="header">
                        <tr>
                            <!-- Columnas estáticas para mantener estado de filtros -->
                            <th *ngIf="isColumnVisible('cd_articulo')" pSortableColumn="cd_articulo">
                                Código
                                <p-sortIcon field="cd_articulo"></p-sortIcon>
                                <p-columnFilter type="numeric" field="cd_articulo" display="menu" matchMode="equals"></p-columnFilter>
                            </th>
                            <th *ngIf="isColumnVisible('nomart')" pSortableColumn="nomart">
                                Nombre
                                <p-sortIcon field="nomart"></p-sortIcon>
                                <p-columnFilter type="text" field="nomart" display="menu" matchMode="contains"></p-columnFilter>
                            </th>
                            <th *ngIf="isColumnVisible('marca')" pSortableColumn="marca">
                                Marca
                                <p-sortIcon field="marca"></p-sortIcon>
                                <p-columnFilter type="text" field="marca" display="menu" matchMode="contains"></p-columnFilter>
                            </th>
                            <th *ngIf="isColumnVisible('precon')" pSortableColumn="precon">
                                Precio Contado
                                <p-sortIcon field="precon"></p-sortIcon>
                                <p-columnFilter type="numeric" field="precon" display="menu"></p-columnFilter>
                            </th>
                            <th *ngIf="isColumnVisible('prefi1')" pSortableColumn="prefi1">
                                Precio 1
                                <p-sortIcon field="prefi1"></p-sortIcon>
                                <p-columnFilter type="numeric" field="prefi1" display="menu"></p-columnFilter>
                            </th>
                            <th *ngIf="isColumnVisible('prefi2')" pSortableColumn="prefi2">
                                Precio 2
                                <p-sortIcon field="prefi2"></p-sortIcon>
                                <p-columnFilter type="numeric" field="prefi2" display="menu"></p-columnFilter>
                            </th>
                            <th *ngIf="isColumnVisible('prefi3')" pSortableColumn="prefi3">
                                Precio 3
                                <p-sortIcon field="prefi3"></p-sortIcon>
                                <p-columnFilter type="numeric" field="prefi3" display="menu"></p-columnFilter>
                            </th>
                            <th *ngIf="isColumnVisible('prefi4')" pSortableColumn="prefi4">
                                Precio 4
                                <p-sortIcon field="prefi4"></p-sortIcon>
                                <p-columnFilter type="numeric" field="prefi4" display="menu"></p-columnFilter>
                            </th>
                            <th *ngIf="isColumnVisible('exi1')" pSortableColumn="exi1">
                                Existencia 1
                                <p-sortIcon field="exi1"></p-sortIcon>
                                <p-columnFilter type="numeric" field="exi1" display="menu"></p-columnFilter>
                            </th>
                            <th *ngIf="isColumnVisible('exi2')" pSortableColumn="exi2">
                                Existencia 2
                                <p-sortIcon field="exi2"></p-sortIcon>
                                <p-columnFilter type="numeric" field="exi2" display="menu"></p-columnFilter>
                            </th>
                            <th *ngIf="isColumnVisible('exi3')" pSortableColumn="exi3">
                                Existencia 3
                                <p-sortIcon field="exi3"></p-sortIcon>
                                <p-columnFilter type="numeric" field="exi3" display="menu"></p-columnFilter>
                            </th>
                            <th *ngIf="isColumnVisible('exi4')" pSortableColumn="exi4">
                                Existencia 4
                                <p-sortIcon field="exi4"></p-sortIcon>
                                <p-columnFilter type="numeric" field="exi4" display="menu"></p-columnFilter>
                            </th>
                            <th *ngIf="isColumnVisible('exi5')" pSortableColumn="exi5">
                                Existencia 5
                                <p-sortIcon field="exi5"></p-sortIcon>
                                <p-columnFilter type="numeric" field="exi5" display="menu"></p-columnFilter>
                            </th>
                            <th *ngIf="isColumnVisible('cd_barra')" pSortableColumn="cd_barra">
                                Código Barra
                                <p-sortIcon field="cd_barra"></p-sortIcon>
                                <p-columnFilter type="text" field="cd_barra" display="menu" matchMode="contains"></p-columnFilter>
                            </th>
                            <th *ngIf="isColumnVisible('rubro')" pSortableColumn="rubro">
                                Rubro
                                <p-sortIcon field="rubro"></p-sortIcon>
                                <p-columnFilter type="text" field="rubro" display="menu" matchMode="contains"></p-columnFilter>
                            </th>
                            <th *ngIf="isColumnVisible('estado')" pSortableColumn="estado">
                                Estado
                                <p-sortIcon field="estado"></p-sortIcon>
                                <p-columnFilter type="text" field="estado" display="menu" matchMode="equals"></p-columnFilter>
                            </th>
                            <th *ngIf="isColumnVisible('cd_proveedor')" pSortableColumn="cd_proveedor">
                                Proveedor
                                <p-sortIcon field="cd_proveedor"></p-sortIcon>
                                <p-columnFilter type="numeric" field="cd_proveedor" display="menu" matchMode="equals"></p-columnFilter>
                            </th>
                            <th *ngIf="isColumnVisible('idart')" pSortableColumn="idart">
                                ID Art
                                <p-sortIcon field="idart"></p-sortIcon>
                                <p-columnFilter type="numeric" field="idart" display="menu" matchMode="equals"></p-columnFilter>
                            </th>
                            <th *ngIf="isColumnVisible('cod_iva')" pSortableColumn="cod_iva">
                                IVA
                                <p-sortIcon field="cod_iva"></p-sortIcon>
                                <p-columnFilter type="numeric" field="cod_iva" display="menu" matchMode="equals"></p-columnFilter>
                            </th>
                            <th *ngIf="isColumnVisible('precostosi')" pSortableColumn="precostosi">
                                Costo s/IVA
                                <p-sortIcon field="precostosi"></p-sortIcon>
                                <p-columnFilter type="numeric" field="precostosi" display="menu"></p-columnFilter>
                            </th>
                            <th *ngIf="isColumnVisible('margen')" pSortableColumn="margen">
                                Margen
                                <p-sortIcon field="margen"></p-sortIcon>
                                <p-columnFilter type="numeric" field="margen" display="menu"></p-columnFilter>
                            </th>
                            <th *ngIf="isColumnVisible('descuento')" pSortableColumn="descuento">
                                Descuento
                                <p-sortIcon field="descuento"></p-sortIcon>
                                <p-columnFilter type="numeric" field="descuento" display="menu"></p-columnFilter>
                            </th>
                            <th *ngIf="isColumnVisible('cod_deposito')" pSortableColumn="cod_deposito">
                                Cód. Depósito
                                <p-sortIcon field="cod_deposito"></p-sortIcon>
                                <p-columnFilter type="numeric" field="cod_deposito" display="menu" matchMode="equals"></p-columnFilter>
                            </th>
                            <th *ngIf="isColumnVisible('tipo_moneda')" pSortableColumn="tipo_moneda">
                                Tipo Moneda
                                <p-sortIcon field="tipo_moneda"></p-sortIcon>
                                <p-columnFilter type="numeric" field="tipo_moneda" display="menu" matchMode="equals"></p-columnFilter>
                            </th>
                            <th>Editar</th>
                            <th>Eliminar</th>
                        </tr>
                    </ng-template>
                    <ng-template pTemplate="body" let-articulo>
                        <tr [class.table-warning]="articulo?._precioError">
                            <td *ngIf="isColumnVisible('cd_articulo')">
                                {{ articulo.cd_articulo }}
                            </td>
                            <td *ngIf="isColumnVisible('nomart')">
                                {{ articulo.nomart }}
                            </td>
                            <td *ngIf="isColumnVisible('marca')">
                                {{ articulo.marca }}
                            </td>
                            <td *ngIf="isColumnVisible('precon')">
                                <span [class.text-danger]="articulo?._precioError && articulo?.tipo_moneda !== 1">
                                    {{ articulo.precon | number:'1.4-4' }}
                                    <i *ngIf="articulo?._precioError && articulo?.tipo_moneda !== 1" 
                                       class="fa fa-exclamation-triangle text-danger" 
                                       title="Posible error en precio por falla en la conversión de moneda"></i>
                                </span>
                            </td>
                            <td *ngIf="isColumnVisible('prefi1')">
                                <span [class.text-danger]="articulo?._precioError && articulo?.tipo_moneda !== 1">
                                    {{ articulo.prefi1 | number:'1.4-4' }}
                                    <i *ngIf="articulo?._precioError && articulo?.tipo_moneda !== 1" 
                                       class="fa fa-exclamation-triangle text-danger" 
                                       title="Posible error en precio por falla en la conversión de moneda"></i>
                                </span>
                            </td>
                            <td *ngIf="isColumnVisible('prefi2')">
                                <span [class.text-danger]="articulo?._precioError && articulo?.tipo_moneda !== 1">
                                    {{ articulo.prefi2 | number:'1.4-4' }}
                                    <i *ngIf="articulo?._precioError && articulo?.tipo_moneda !== 1" 
                                       class="fa fa-exclamation-triangle text-danger" 
                                       title="Posible error en precio por falla en la conversión de moneda"></i>
                                </span>
                            </td>
                            <td *ngIf="isColumnVisible('prefi3')">
                                <span [class.text-danger]="articulo?._precioError && articulo?.tipo_moneda !== 1">
                                    {{ articulo.prefi3 | number:'1.4-4' }}
                                    <i *ngIf="articulo?._precioError && articulo?.tipo_moneda !== 1" 
                                       class="fa fa-exclamation-triangle text-danger" 
                                       title="Posible error en precio por falla en la conversión de moneda"></i>
                                </span>
                            </td>
                            <td *ngIf="isColumnVisible('prefi4')">
                                <span [class.text-danger]="articulo?._precioError && articulo?.tipo_moneda !== 1">
                                    {{ articulo.prefi4 | number:'1.4-4' }}
                                    <i *ngIf="articulo?._precioError && articulo?.tipo_moneda !== 1" 
                                       class="fa fa-exclamation-triangle text-danger" 
                                       title="Posible error en precio por falla en la conversión de moneda"></i>
                                </span>
                            </td>
                            <td *ngIf="isColumnVisible('exi1')">
                                {{ articulo.exi1 | number:'1.0-0' }}
                            </td>
                            <td *ngIf="isColumnVisible('exi2')">
                                {{ articulo.exi2 | number:'1.0-0' }}
                            </td>
                            <td *ngIf="isColumnVisible('exi3')">
                                {{ articulo.exi3 | number:'1.0-0' }}
                            </td>
                            <td *ngIf="isColumnVisible('exi4')">
                                {{ articulo.exi4 | number:'1.0-0' }}
                            </td>
                            <td *ngIf="isColumnVisible('exi5')">
                                {{ articulo.exi5 | number:'1.0-0' }}
                            </td>
                            <td *ngIf="isColumnVisible('cd_barra')">
                                {{ articulo.cd_barra }}
                            </td>
                            <td *ngIf="isColumnVisible('rubro')">
                                {{ articulo.rubro }}
                            </td>
                            <td *ngIf="isColumnVisible('estado')">
                                {{ articulo.estado }}
                            </td>
                            <td *ngIf="isColumnVisible('cd_proveedor')">
                                {{ articulo.cd_proveedor }}
                            </td>
                            <td *ngIf="isColumnVisible('idart')">
                                {{ articulo.idart }}
                            </td>
                            <td *ngIf="isColumnVisible('cod_iva')">
                                {{ articulo.cod_iva }}
                            </td>
                            <td *ngIf="isColumnVisible('precostosi')">
                                <span [class.text-danger]="articulo?._precioError && articulo?.tipo_moneda !== 1">
                                    {{ articulo.precostosi | number:'1.4-4' }}
                                    <i *ngIf="articulo?._precioError && articulo?.tipo_moneda !== 1" 
                                       class="fa fa-exclamation-triangle text-danger" 
                                       title="Posible error en precio por falla en la conversión de moneda"></i>
                                </span>
                            </td>
                            <td *ngIf="isColumnVisible('margen')">
                                {{ articulo.margen | number:'1.2-2' }}
                            </td>
                            <td *ngIf="isColumnVisible('descuento')">
                                {{ articulo.descuento | number:'1.2-2' }}
                            </td>
                            <td *ngIf="isColumnVisible('cod_deposito')">
                                {{ articulo.cod_deposito }}
                            </td>
                            <td *ngIf="isColumnVisible('tipo_moneda')">
                                {{ obtenerNombreMoneda(articulo.tipo_moneda) }}
                            </td>
                            <td>
                                <p-button icon="pi pi-pencil" styleClass="p-button-sm p-button-help"
                                    (click)="editArticulo(articulo)"></p-button>
                            </td>
                            <td>
                                <p-button icon="pi pi-trash" styleClass="p-button-sm p-button-danger"
                                (click)="confirmDelete(articulo)"></p-button>
                            </td>
                        </tr>
                    </ng-template>
                    <ng-template pTemplate="emptymessage">
                        <tr>
                            <td colspan="25" class="text-center p-4">
                                <div *ngIf="loading">
                                    <i class="fa fa-spinner fa-spin fa-2x mb-2"></i>
                                    <p>Cargando artículos...</p>
                                </div>
                                <div *ngIf="!loading">
                                    <i class="fa fa-database fa-2x mb-2"></i>
                                    <p>No se encontraron artículos</p>
                                </div>
                            </td>
                        </tr>
                    </ng-template>
                </p-table>

            </div>
        </div>
    </div>
</div>